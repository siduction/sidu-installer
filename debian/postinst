#! /bin/bash
# postinst script for #PACKAGE#
#

set -e

PROJECT=sidu-installer
MY_DIR=/usr/share/$PROJECT
# useless, never used MY_BACKEND=../sidu-base

BASE_BACKEND=/usr/share/sidu-base/backend
BASE_SCRIPTS=/usr/share/sidu-base/scripts
MY_BACKEND=../../$PROJECT/backend
MY_SCRIPTS=../../$PROJECT/scripts


function MkLink() {
        if [ ! -L $1 ] ; then
                ln -sf $2/$1 $1
        fi
}

function MkLink2() {
        if [ ! -L $2 ] ; then
                ln -sf $1 $2
        fi
}


case "$1" in
    configure)
        if [ -f /etc/skel/Desktop/$PROJECT.desktop ]; then
            chmod 755 /etc/skel/Desktop/$PROJECT.desktop
        fi
        if grep -q $PROJECT /etc/hosts ; then
        	perl -pi -e "s/^.*$PROJECT.*/127.0.0.86 $PROJECT/;" /etc/hosts
        else
            # if the last newline is missing:
            tail -n1 /etc/hosts | hd | grep -q "0a" || echo "" >>/etc/hosts
            echo "127.0.0.86 $PROJECT" >>/etc/hosts
            echo "virtual host installed: $PROJECT (127.0.0.86)"
        fi

        # Create the links from the toolkit:
        # useless, owerwritten -  pushd $MY_DIR >/dev/null
        cd $BASE_BACKEND
        # Create the links to the shellserver:
        MkLink install.sh $MY_BACKEND
        MkLink partinfo.pl $MY_BACKEND
        MkLink partinfo.sh $MY_BACKEND
        MkLink timezoneinfo.sh $MY_BACKEND
        MkLink firmware.sh $MY_BACKEND
        MkLink firmware.pl $MY_BACKEND
        MkLink nonfree.sh $MY_BACKEND
        MkLink autopart.sh $MY_BACKEND
        MkLink autopart.pl $MY_BACKEND
        cd $BASE_SCRIPTS
		MkLink checkupdate.py $MY_SCRIPTS
		MkLink packetupdate.py $MY_SCRIPTS

		cd $BASE_BACKEND
        MkLink2 $BASE_BACKEND/automount-control.sh $MY_BACKEND
        MkLink2 /var/cache/sidu-base/public $MY_DIR/installer/static/

        # a fucking service start must not prevail the installation of a
        # package in no way - therefore it always returns true AG 2015-10-09
        pywwetha-control restart | true

        # useless noop - popd >/dev/null
    ;;

    abort-upgrade|abort-remove|abort-deconfigure)
    ;;

    *)
        echo "postinst called with unknown argument \`$1'" >&2
        exit 1
    ;;
esac

# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.

#DEBHELPER#

exit 0
